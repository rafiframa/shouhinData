<!-- views/products.ejs -->
<%- include('./layout/header') %>

    <br>
    <% if (notification) { %>
        <div class="notification-banner <%= notification.type %>">
            <div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <%= notification.message %>
            </div>
            <span class="close-notification">&times;</span>
        </div>
        <% } %>
            <!-- Search and Add Product Section -->
            <div class="top-controls">
                <div class="search-container">
                    <!-- Replace the existing search form with this updated version -->
                    <form class="search-form" method="GET" action="/">
                        <!-- Hidden input to reset to page 1 when searching -->
                        <input type="hidden" name="page" value="1">

                        <div class="search-group">
                            <input type="text" name="search" id="searchName" placeholder="商品名・カテゴリーで検索..."
                                value="<%= searchParams.search %>">
                        </div>
                        <div class="search-group">
                            <select name="product_type" id="searchType">
                                <option value="">すべてのカテゴリー</option>
                                <option value="WAM" <%=searchParams.product_type==='WAM' ? 'selected' : '' %>
                                    >WAM</option>
                                <option value="フェンス" <%=searchParams.product_type==='フェンス' ? 'selected' : '' %>
                                    >フェンス</option>
                                <option value="飼料" <%=searchParams.product_type==='飼料' ? 'selected' : '' %>>飼料
                                </option>
                                <option value="畜産" <%=searchParams.product_type==='畜産' ? 'selected' : '' %>>畜産
                                </option>
                                <option value="電気柵" <%=searchParams.product_type==='電気柵' ? 'selected' : '' %>>電気柵
                                </option>
                                 <!-- <option value="" <%=(searchParams.product_type === null || searchParams.product_type === undefined) ? 'selected' : '' %>>その他
                                 </option> -->
                            </select>
                        </div>
                        <div class="search-group">
                            <select name="sales_status" id="searchStatus">
                                <option value="">すべての販売状況</option>
                                <option value="販売中" <%=searchParams.sales_status==='販売中' ? 'selected' : '' %>>販売中
                                </option>
                                <option value="受注生産" <%=searchParams.sales_status==='受注生産' ? 'selected' : '' %>>受注生産
                                </option>
                                <option value="販売停止中" <%=searchParams.sales_status==='販売停止中' ? 'selected' : '' %>>販売停止中
                                </option>
                                <option value="廃盤" <%=searchParams.sales_status==='廃盤' ? 'selected' : '' %>>廃盤</option>
                            </select>
                        </div>
                        <button type="submit" class="btn search-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            検索
                        </button>
                        <a href="/" class="btn clear-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                            </svg>
                            クリア
                        </a>
                    </form>
                </div>
                <%if (user && user.role==='admin' ) { %>
                    <div class="add-product-container">
                        <button id="openModalBtn" class="btn add-product-btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right: 5px; vertical-align: text-bottom;">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            新商品追加
                        </button>
                    </div>
                    <% } %>
            </div>

            <!-- Search Results Counter -->
            <% if (searchParams.search || searchParams.product_type || searchParams.sales_status) { %>
                <div class="search-results-info">
                    <span class="results-count">
                        <%= products.length %> 件の商品が見つかりました
                    </span>
                    <% if (searchParams.search) { %>
                        <span class="search-term">「<%= searchParams.search %>」</span>
                        <% } %>
                            <% if (searchParams.product_type) { %>
                                <span class="filter-badge">カテゴリー: <%= searchParams.product_type %></span>
                                <% } %>
                                    <% if (searchParams.sales_status) { %>
                                        <span class="filter-badge">販売状況: <%= searchParams.sales_status %></span>
                                        <% } %>
                </div>
                <% } %>
                            <div class="product-list">
                                <table id="product-table">
                                   <thead>
                                        <tr>
                                            <th>
                                                <a href="?<%= new URLSearchParams({...searchParams, sort: 'id', order: searchParams.sort === 'id' && searchParams.order === 'asc' ? 'desc' : 'asc'}).toString() %>" 
                                                class="sortable-header <%= searchParams.sort === 'id' ? 'active' : '' %>">
                                                    ID
                                                    <% if (searchParams.sort === 'id') { %>
                                                        <span class="sort-icon"><%= searchParams.order === 'asc' ? '▲' : '▼' %></span>
                                                    <% } %>
                                                </a>
                                            </th>
                                            <th>
                                                <a href="?<%= new URLSearchParams({...searchParams, sort: 'product_name', order: searchParams.sort === 'product_name' && searchParams.order === 'asc' ? 'desc' : 'asc'}).toString() %>" 
                                                class="sortable-header <%= searchParams.sort === 'product_name' ? 'active' : '' %>">
                                                    商品名
                                                    <% if (searchParams.sort === 'product_name') { %>
                                                        <span class="sort-icon"><%= searchParams.order === 'asc' ? '▲' : '▼' %></span>
                                                    <% } %>
                                                </a>
                                            </th>
                                            <th>
                                                <a href="?<%= new URLSearchParams({...searchParams, sort: 'product_type', order: searchParams.sort === 'product_type' && searchParams.order === 'asc' ? 'desc' : 'asc'}).toString() %>" 
                                                class="sortable-header <%= searchParams.sort === 'product_type' ? 'active' : '' %>">
                                                    商品カテゴリー
                                                    <% if (searchParams.sort === 'product_type') { %>
                                                        <span class="sort-icon"><%= searchParams.order === 'asc' ? '▲' : '▼' %></span>
                                                    <% } %>
                                                </a>
                                            </th>
                                            <th>
                                                <a href="?<%= new URLSearchParams({...searchParams, sort: 'sales_status', order: searchParams.sort === 'sales_status' && searchParams.order === 'asc' ? 'desc' : 'asc'}).toString() %>" 
                                                class="sortable-header <%= searchParams.sort === 'sales_status' ? 'active' : '' %>">
                                                    販売状況
                                                    <% if (searchParams.sort === 'sales_status') { %>
                                                        <span class="sort-icon"><%= searchParams.order === 'asc' ? '▲' : '▼' %></span>
                                                    <% } %>
                                                </a>
                                            </th>
                                            <th>
                                                <a href="?<%= new URLSearchParams({...searchParams, sort: 'list_price', order: searchParams.sort === 'list_price' && searchParams.order === 'asc' ? 'desc' : 'asc'}).toString() %>" 
                                                class="sortable-header <%= searchParams.sort === 'list_price' ? 'active' : '' %>">
                                                    標準価格（税抜）
                                                    <% if (searchParams.sort === 'list_price') { %>
                                                        <span class="sort-icon"><%= searchParams.order === 'asc' ? '▲' : '▼' %></span>
                                                    <% } %>
                                                </a>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (products.length===0) { %>
                                            <tr>
                                                <td colspan="5"
                                                    style="text-align: center; padding: 2rem; color: var(--text-color); font-style: italic;">
                                                    <% if (searchParams.search || searchParams.product_type ||
                                                        searchParams.sales_status) { %>
                                                        検索条件に一致する商品が見つかりません
                                                        <% } else { %>
                                                            登録されている商品がありません
                                                            <% } %>
                                                </td>
                                            </tr>
                                            <% } else { %>
                                                <% products.forEach(product=> { %>
                                                    <tr onclick="location.href='/product/<%= product.id %>'">
                                                        <td>
                                                            <%= product.product_code %>
                                                        </td>
                                                        <td>
                                                            <%= product.product_name %>
                                                        </td>
                                                        <td>
                                                            <%= product.product_type || '' %>
                                                        </td>
                                                        <td>
                                                            <%= product.sales_status %>
                                                        </td>
                                                        <td>¥<%= (+product.list_price).toLocaleString('en-US', {
                                                                maximumFractionDigits: 0 }) %>
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination Controls -->
                            <% if (pagination && pagination.totalPages> 1) { %>
                                <div class="pagination-container">
                                    <div class="pagination">
                                        <!-- Previous Page -->
                                        <% if (pagination.hasPrevPage) { %>
                                            <a href="?<%= new URLSearchParams({...searchParams, page: pagination.currentPage - 1}).toString() %>"
                                                class="pagination-btn pagination-prev">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <polyline points="15,18 9,12 15,6"></polyline>
                                                </svg>
                                                前へ
                                            </a>
                                            <% } else { %>
                                                <span class="pagination-btn pagination-prev disabled">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2">
                                                        <polyline points="15,18 9,12 15,6"></polyline>
                                                    </svg>
                                                    前へ
                                                </span>
                                                <% } %>

                                                    <!-- Page Numbers -->
                                                    <div class="pagination-numbers">
                                                        <% // Calculate which page numbers to show const
                                                            startPage=Math.max(1, pagination.currentPage - 2); const
                                                            endPage=Math.min(pagination.totalPages,
                                                            pagination.currentPage + 2); %>

                                                            <!-- First page if not in range -->
                                                            <% if (startPage> 1) { %>
                                                                <a href="?<%= new URLSearchParams({...searchParams, page: 1}).toString() %>"
                                                                    class="pagination-number">1</a>
                                                                <% if (startPage> 2) { %>
                                                                    <span class="pagination-ellipsis">...</span>
                                                                    <% } %>
                                                                        <% } %>

                                                                            <!-- Page numbers in range -->
                                                                            <% for (let i=startPage; i <=endPage; i++) {
                                                                                %>
                                                                                <% if (i===pagination.currentPage) { %>
                                                                                    <span
                                                                                        class="pagination-number active">
                                                                                        <%= i %>
                                                                                    </span>
                                                                                    <% } else { %>
                                                                                        <a href="?<%= new URLSearchParams({...searchParams, page: i}).toString() %>"
                                                                                            class="pagination-number">
                                                                                            <%= i %>
                                                                                        </a>
                                                                                        <% } %>
                                                                                            <% } %>

                                                                                                <!-- Last page if not in range -->
                                                                                                <% if (endPage <
                                                                                                    pagination.totalPages)
                                                                                                    { %>
                                                                                                    <% if (endPage <
                                                                                                        pagination.totalPages
                                                                                                        - 1) { %>
                                                                                                        <span
                                                                                                            class="pagination-ellipsis">...</span>
                                                                                                        <% } %>
                                                                                                            <a href="?<%= new URLSearchParams({...searchParams, page: pagination.totalPages}).toString() %>"
                                                                                                                class="pagination-number">
                                                                                                                <%= pagination.totalPages
                                                                                                                    %>
                                                                                                            </a>
                                                                                                            <% } %>
                                                    </div>

                                                    <!-- Next Page -->
                                                    <% if (pagination.hasNextPage) { %>
                                                        <a href="?<%= new URLSearchParams({...searchParams, page: pagination.currentPage + 1}).toString() %>"
                                                            class="pagination-btn pagination-next">
                                                            次へ
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2">
                                                                <polyline points="9,18 15,12 9,6"></polyline>
                                                            </svg>
                                                        </a>
                                                        <% } else { %>
                                                            <span class="pagination-btn pagination-next disabled">
                                                                次へ
                                                                <svg width="16" height="16" viewBox="0 0 24 24"
                                                                    fill="none" stroke="currentColor" stroke-width="2">
                                                                    <polyline points="9,18 15,12 9,6"></polyline>
                                                                </svg>
                                                            </span>
                                                            <% } %>
                                    </div>
                                </div>
                                <% } %>
                                    <!-- Add Product Modal -->
                                    <div id="addProductModal" class="modal">
                                        <div class="modal-content enhanced-modal">
                                            <div class="modal-header">
                                                <h2>新商品登録</h2>
                                                <span class="close-modal">&times;</span>
                                            </div>
                                            <div class="modal-body">
                                                <form id="addProductForm" class="enhanced-form">
                                                    <!-- Basic Product Info Section -->
                                                    <div class="form-section">
                                                        
                                                        <div class="form-group">
                                                            <label for="product_name">商品名 *</label>
                                                            <input type="text" id="product_name" name="product_name"
                                                                required>
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="product_code">商品コード *</label>
                                                            <input type="text" id="product_code" name="product_code"
                                                                required>
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="list_price">標準価格（税抜）*</label>
                                                            <input type="number" id="list_price" name="list_price"
                                                                required>
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="image">商品画像URL</label>
                                                            <input type="url" id="image" name="image">
                                                        </div>
                                                    </div>

                                                    <!-- Three-column grid for detailed information -->
                                                    <div class="product-grid three-columns">
                                                        <div class="info-section">
                                                            <h3>基本情報</h3>

                                                            <div class="form-group">
                                                                <label for="order_number">発注番号</label>
                                                                <input type="text" id="order_number"
                                                                    name="order_number">
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="product_type">商品カテゴリー</label>
                                                                <select id="product_type" name="product_type">
                                                                    <option value="">選択してください</option>
                                                                    <option value="WAM">WAM</option>
                                                                    <option value="フェンス">フェンス</option>
                                                                    <option value="飼料">飼料</option>
                                                                    <option value="畜産">畜産</option>
                                                                    <option value="電気柵">電気柵</option>
                                                                    <!-- <option value="その他">その他</option> -->
                                                                </select>
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="sales_status">販売状況</label>
                                                                <select id="sales_status" name="sales_status">
                                                                    <option value="販売中">販売中</option>
                                                                    <option value="受注生産">受注生産</option>
                                                                    <option value="販売停止中">販売停止中</option>
                                                                    <option value="廃盤">廃盤</option>
                                                                </select>
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="jan_code">JANコード</label>
                                                                <input type="text" id="jan_code" name="jan_code">
                                                            </div>
                                                        </div>

                                                        <div class="info-section">
                                                            <h3>仕入情報</h3>

                                                            <div class="form-group">
                                                                <label for="supplier_product_code">仕入先商品コード</label>
                                                                <input type="text" id="supplier_product_code"
                                                                    name="supplier_product_code">
                                                            </div>

                                                            <div class="currency-pair">
                                                                <div class="form-group">
                                                                    <label for="supplier_cost_local">仕入原価（取引通貨・税抜）</label>
                                                                    <input type="number" step="0.01"
                                                                        id="supplier_cost_local"
                                                                        name="supplier_cost_local">
                                                                </div>

                                                                <div class="form-group">
                                                                    <label for="supplier_cost_currency">通貨</label>
                                                                    <select id="supplier_cost_currency"
                                                                        name="supplier_cost_currency">
                                                                        <option value="">選択</option>
                                                                        <option value="JPY">JPY</option>
                                                                        <option value="USD">USD</option>
                                                                        <option value="EUR">EUR</option>
                                                                        <option value="CNY">CNY</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="info-section">
                                                            <h3>製品仕様</h3>

                                                            <div class="form-group">
                                                                <label for="dimensions_mm">寸法 (mm)</label>
                                                                <input type="number" id="dimensions_mm"
                                                                    name="dimensions_mm" placeholder="例: 100x50x25">
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="weight_g">重量 (g)</label>
                                                                <input type="number" step="0.1" id="weight_g"
                                                                    name="weight_g">
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="material">材質</label>
                                                                <input type="text" id="material" name="material">
                                                            </div>

                                                            <div class="form-group">
                                                                <label for="durability_years">耐用年数（法定耐用年数）</label>
                                                                <input type="number" id="durability_years"
                                                                    name="durability_years">
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Other Specifications -->
                                                    <div class="info-section">
                                                        <h3>その他仕様</h3>
                                                        <div class="form-group">
                                                            <textarea id="other_specs" name="other_specs" rows="4"
                                                                placeholder="その他の仕様や特記事項"></textarea>
                                                        </div>
                                                    </div>

                                                    <!-- Resource Links -->
                                                    <div class="info-section">
                                                        <h3>リソースリンク</h3>

                                                        <div class="form-group">
                                                            <label for="label_link">ラベルリンク</label>
                                                            <input type="url" id="label_link" name="label_link"
                                                                placeholder="https://example.com/label">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="packaging_link">梱包リンク</label>
                                                            <input type="url" id="packaging_link" name="packaging_link"
                                                                placeholder="https://example.com/packaging">
                                                        </div>

                                                        <div class="form-group">
                                                            <label for="manual_link">マニュアルリンク</label>
                                                            <input type="url" id="manual_link" name="manual_link"
                                                                placeholder="https://example.com/manual">
                                                        </div>
                                                    </div>

                                                    <!-- Form Actions -->
                                                    <div class="form-actions">
                                                        <button type="button" class="btn cancel-btn" id="cancelBtn">
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                style="margin-right: 5px; vertical-align: text-bottom;">
                                                                <path d="M18 6L6 18"></path>
                                                                <path d="M6 6l12 12"></path>
                                                            </svg>
                                                            キャンセル
                                                        </button>
                                                        <button type="submit" class="btn submit-btn">
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                style="margin-right: 5px; vertical-align: text-bottom;">
                                                                <path
                                                                    d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z">
                                                                </path>
                                                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                                                <polyline points="7 3 7 8 15 8"></polyline>
                                                            </svg>
                                                            登録する
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Loading overlay -->
                                    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                                        <div class="loading-spinner">登録中...</div>
                                    </div>

                                    <script>
                                        // Modal functionality
                                        const modal = document.getElementById('addProductModal');
                                        const openModalBtn = document.getElementById('openModalBtn');
                                        const closeModal = document.querySelector('.close-modal');
                                        const cancelBtn = document.getElementById('cancelBtn');
                                        const addProductForm = document.getElementById('addProductForm');
                                        const loadingOverlay = document.getElementById('loadingOverlay');

                                        // Open modal
                                        openModalBtn.addEventListener('click', () => {
                                            modal.style.display = 'block';
                                            document.body.classList.add('modal-open');
                                        });

                                        // Close modal functions
                                        function closeModalFunction() {
                                            modal.style.display = 'none';
                                            document.body.classList.remove('modal-open');
                                            addProductForm.reset();
                                        }

                                        closeModal.addEventListener('click', closeModalFunction);
                                        cancelBtn.addEventListener('click', closeModalFunction);

                                        // Form submission
                                        addProductForm.addEventListener('submit', async (e) => {
                                            e.preventDefault();

                                            // Show loading overlay
                                            loadingOverlay.style.display = 'flex';

                                            // Create FormData and convert to object
                                            const formData = new FormData(addProductForm);
                                            const productData = {};

                                            formData.forEach((value, key) => {
                                                // Convert empty strings to null for optional fields
                                                productData[key] = value.trim() === '' ? null : value.trim();
                                            });

                                            // Convert numeric fields
                                            if (productData.list_price) productData.list_price = parseFloat(productData.list_price);
                                            if (productData.supplier_cost_local) productData.supplier_cost_local = parseFloat(productData.supplier_cost_local);
                                            if (productData.weight_g) productData.weight_g = parseFloat(productData.weight_g);
                                            if (productData.durability_years) productData.durability_years = parseInt(productData.durability_years);

                                            try {
                                                const response = await fetch('/api/products', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    },
                                                    body: JSON.stringify(productData)
                                                });

                                                if (!response.ok) {
                                                    const errorData = await response.json();
                                                    throw new Error(errorData.message || '商品の追加に失敗しました');
                                                }

                                                const data = await response.json();

                                                // Close modal and reset form
                                                closeModalFunction();

                                                // Show success notification and reload page to show new product
                                                showNotification('商品が正常に追加されました', 'success');

                                                // Reload page after a short delay to show the new product
                                                setTimeout(() => {
                                                    window.location.reload();
                                                }, 1500);

                                            } catch (error) {
                                                console.error('Error adding product:', error)
                                                showNotification(error.message || '商品の追加に失敗しました', 'error');
                                            } finally {
                                                // Hide loading overlay
                                                loadingOverlay.style.display = 'none';
                                            }
                                        });

                                        // Form validation
                                        const requiredFields = document.querySelectorAll('input[required]');
                                        requiredFields.forEach(field => {
                                            field.addEventListener('blur', validateField);
                                            field.addEventListener('input', clearFieldError);
                                        });

                                        function validateField(e) {
                                            const field = e.target;
                                            if (!field.value.trim()) {
                                                field.classList.add('error');
                                                showFieldError(field, 'この項目は必須です');
                                            } else {
                                                field.classList.remove('error');
                                                clearFieldError(field);
                                            }
                                        }

                                        function clearFieldError(e) {
                                            const field = e.target;
                                            field.classList.remove('error');
                                            const errorElement = field.parentNode.querySelector('.field-error');
                                            if (errorElement) {
                                                errorElement.remove();
                                            }
                                        }

                                        function showFieldError(field, message) {
                                            clearFieldError({ target: field });
                                            const errorElement = document.createElement('div');
                                            errorElement.className = 'field-error';
                                            errorElement.textContent = message;
                                            errorElement.style.color = 'var(--danger)';
                                            errorElement.style.fontSize = '0.875rem';
                                            errorElement.style.marginTop = '0.25rem';
                                            field.parentNode.appendChild(errorElement);
                                        }

                                        // Notification function
                                        function showNotification(message, type) {
                                            const notification = document.createElement('div');
                                            notification.className = `notification ${type}`;
                                            notification.textContent = message;

                                            document.body.appendChild(notification);

                                            // Show notification
                                            setTimeout(() => {
                                                notification.classList.add('show');
                                            }, 10);

                                            // Remove notification after 5 seconds
                                            setTimeout(() => {
                                                notification.classList.remove('show');
                                                setTimeout(() => {
                                                    document.body.removeChild(notification);
                                                }, 300);
                                            }, 5000);
                                        }

                                        const notificationBanner = document.querySelector('.notification-banner');
                                        if (notificationBanner) {
                                            const closeNotification = notificationBanner.querySelector('.close-notification');

                                            closeNotification.addEventListener('click', () => {
                                                notificationBanner.style.opacity = '0';
                                                setTimeout(() => {
                                                    notificationBanner.remove();
                                                }, 300);
                                            });

                                            // Auto-dismiss after 5 seconds
                                            setTimeout(() => {
                                                notificationBanner.style.opacity = '0';
                                                setTimeout(() => {
                                                    notificationBanner.remove();
                                                }, 300);
                                            }, 5000);
                                        }

                                        // Search functionality----------------------------------------------------------------------------
                                        const searchName = document.getElementById('searchName');
                                        const searchType = document.getElementById('searchType');
                                        const searchStatus = document.getElementById('searchStatus');
                                        const clearSearch = document.getElementById('clearSearch');
                                        const productTable = document.getElementById('product-table');
                                        const tableRows = productTable.querySelectorAll('tbody tr');

                                        function performSearch() {
                                            const nameQuery = searchName.value.toLowerCase().trim();
                                            const typeQuery = searchType.value.toLowerCase().trim();
                                            const statusQuery = searchStatus.value.toLowerCase().trim();

                                            let visibleCount = 0;

                                            tableRows.forEach(row => {
                                                const productName = row.cells[1].textContent.toLowerCase();
                                                const productType = row.cells[2].textContent.toLowerCase();
                                                const salesStatus = row.cells[3].textContent.toLowerCase();

                                                const nameMatch = nameQuery === '' || productName.includes(nameQuery);
                                                const typeMatch = typeQuery === '' || material.includes(typeQuery);
                                                const statusMatch = statusQuery === '' || salesStatus.includes(statusQuery);

                                                if (nameMatch && typeMatch && statusMatch) {
                                                    row.style.display = '';
                                                    visibleCount++;
                                                } else {
                                                    row.style.display = 'none';
                                                }
                                            });

                                            // Show/hide "no results" message
                                            updateNoResultsMessage(visibleCount);

                                            // Update search results counter
                                            updateSearchCounter(visibleCount, tableRows.length);
                                        }

                                        function updateNoResultsMessage(visibleCount) {
                                            let noResultsRow = document.getElementById('no-results-row');

                                            if (visibleCount === 0) {
                                                if (!noResultsRow) {
                                                    noResultsRow = document.createElement('tr');
                                                    noResultsRow.id = 'no-results-row';
                                                    noResultsRow.innerHTML = '<td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-color); font-style: italic;">検索条件に一致する商品が見つかりません</td>';
                                                    productTable.querySelector('tbody').appendChild(noResultsRow);
                                                }
                                                noResultsRow.style.display = '';
                                            } else {
                                                if (noResultsRow) {
                                                    noResultsRow.style.display = 'none';
                                                }
                                            }
                                        }

                                        function updateSearchCounter(visibleCount, totalCount) {
                                            let counter = document.getElementById('search-counter');
                                            if (!counter) {
                                                counter = document.createElement('div');
                                                counter.id = 'search-counter';
                                                counter.className = 'search-counter';
                                                document.querySelector('.top-controls').appendChild(counter);
                                            }

                                            if (visibleCount < totalCount) {
                                                counter.textContent = `${visibleCount} / ${totalCount} 件の商品を表示`;
                                                counter.style.display = 'block';
                                            } else {
                                                counter.style.display = 'none';
                                            }
                                        }

                                        function clearSearchFilters() {
                                            searchName.value = '';
                                            searchType.value = '';
                                            searchStatus.value = '';
                                            tableRows.forEach(row => {
                                                row.style.display = '';
                                            });
                                            updateNoResultsMessage(tableRows.length);
                                            updateSearchCounter(tableRows.length, tableRows.length);
                                        }

                                        clearSearch.addEventListener('click', clearSearchFilters);

                                        // Initialize search counter
                                        updateSearchCounter(tableRows.length, tableRows.length);
                                        // ---------------------------------------------------------------------------------------
                                    </script>

                                    <style>
                                        /* Enhanced Modal Styles */
                                        .enhanced-modal {
                                            max-width: 1200px;
                                            width: 95%;
                                        }

                                        .enhanced-form .form-section {
                                            background-color: var(--white);
                                            padding: 1.5rem;
                                            border-radius: 8px;
                                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                                            margin-bottom: 2rem;
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 1.5rem;
                                        }

                                        .enhanced-form .info-section {
                                            background-color: var(--white);
                                            padding: 1.5rem;
                                            border-radius: 8px;
                                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                                            margin-bottom: 1.5rem;
                                            transition: transform 0.2s, box-shadow 0.2s;
                                        }

                                        .enhanced-form .info-section:hover {
                                            transform: translateY(-3px);
                                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                                        }

                                        .enhanced-form .info-section h3 {
                                            color: var(--primary-color);
                                            border-bottom: 2px solid var(--primary-light);
                                            padding-bottom: 0.7rem;
                                            margin-bottom: 1.2rem;
                                            font-size: 1.25rem;
                                            text-align: center;
                                            margin-top: 0;
                                        }

                                        .enhanced-form .form-group {
                                            margin-bottom: 1.2rem;
                                        }

                                        .enhanced-form .form-group label {
                                            display: block;
                                            margin-bottom: 0.5rem;
                                            font-weight: 500;
                                            color: var(--primary-color);
                                            font-size: 1rem;
                                        }

                                        .enhanced-form .form-group input,
                                        .enhanced-form .form-group select,
                                        .enhanced-form .form-group textarea {
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 1px solid var(--border-color);
                                            border-radius: 6px;
                                            font-family: inherit;
                                            font-size: 1rem;
                                            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
                                            transition: border-color 0.2s, box-shadow 0.2s;
                                            box-sizing: border-box;
                                        }

                                        .enhanced-form .form-group input:focus,
                                        .enhanced-form .form-group select:focus,
                                        .enhanced-form .form-group textarea:focus {
                                            outline: none;
                                            border-color: var(--primary-color);
                                            box-shadow: 0 0 0 3px rgba(94, 112, 84, 0.1);
                                        }

                                        .enhanced-form .form-group input.error {
                                            border-color: var(--danger);
                                            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
                                        }

                                        .enhanced-form .form-group textarea {
                                            resize: vertical;
                                            min-height: 100px;
                                        }

                                        /* Currency pair styling for modal */
                                        .enhanced-form .currency-pair {
                                            display: flex;
                                            gap: 1rem;
                                            align-items: end;
                                        }

                                        .enhanced-form .currency-pair .form-group:first-child {
                                            flex: 2;
                                        }

                                        .enhanced-form .currency-pair .form-group:last-child {
                                            flex: 1;
                                        }

                                        .enhanced-form .currency-pair .form-group {
                                            margin-bottom: 0;
                                        }

                                        /* Three-column grid for modal */
                                        .enhanced-form .product-grid.three-columns {
                                            display: grid;
                                            grid-template-columns: 1fr 1fr 1fr;
                                            gap: 1.5rem;
                                        }

                                        /* Form actions for modal */
                                        .enhanced-form .form-actions {
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            padding-top: 2rem;
                                            border-top: 1px solid var(--border-color);
                                            margin-top: 2rem;
                                        }

                                        /* Loading overlay */
                                        .loading-overlay {
                                            position: fixed;
                                            top: 0;
                                            left: 0;
                                            width: 100%;
                                            height: 100%;
                                            background-color: rgba(0, 0, 0, 0.5);
                                            display: flex;
                                            justify-content: center;
                                            align-items: center;
                                            z-index: 9999;
                                        }

                                        .loading-spinner {
                                            background-color: var(--white);
                                            padding: 2rem;
                                            border-radius: 8px;
                                            font-size: 1.2rem;
                                            font-weight: 500;
                                            color: var(--primary-color);
                                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                                        }

                                        /* Field error styles */
                                        .field-error {
                                            color: var(--danger);
                                            font-size: 0.875rem;
                                            margin-top: 0.25rem;
                                        }

                                        /* --------------------------------------------------------------------------------------------- */
                                        /* Top Controls Layout */
                                        .top-controls {
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: flex-start;
                                            gap: 2rem;
                                            margin-bottom: 1.5rem;
                                            flex-wrap: wrap;
                                        }

                                        /* Search Styles */
                                        .search-container {
                                            flex: 1;
                                            background: linear-gradient(135deg, var(--primary-light) 0%, #f8f9fa 100%);
                                            padding: 1.5rem;
                                            border-radius: 12px;
                                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                                            border: 1px solid rgba(94, 112, 84, 0.1);
                                            /* max-width: 1000px; */
                                            margin: 0 auto;
                                        }

                                        .search-form {
                                            display: grid;
                                            grid-template-columns: 2fr 1fr 1fr auto auto;
                                            gap: 1rem;
                                            align-items: center;
                                            align-items: end;
                                        }

                                        .search-group {
                                            flex: 1;
                                            min-width: 150px;
                                        }

                                        .search-group input,
                                        .search-group select {
                                            width: 100%;
                                            padding: 0.875rem 1rem;
                                            border: 2px solid var(--border-color);
                                            border-radius: 8px;
                                            font-size: 0.95rem;
                                            background-color: var(--white);
                                            transition: all 0.3s ease;
                                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                            box-sizing: border-box;
                                            margin: auto;
                                        }

                                        .search-group input:focus,
                                        .search-group select:focus {
                                            outline: none;
                                            border-color: var(--primary-color);
                                            box-shadow: 0 0 0 4px rgba(94, 112, 84, 0.12), 0 4px 8px rgba(0, 0, 0, 0.1);
                                            transform: translateY(-1px);
                                        }

                                        .search-group input::placeholder {
                                            color: #999;
                                            font-style: italic;
                                        }

                                        .search-actions {
                                            display: flex;
                                            gap: 0.75rem;
                                            align-items: center;
                                        }

                                        .search-btn {
                                            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                                            color: var(--white);
                                            border: none;
                                            padding: 0.875rem 1.25rem;
                                            border-radius: 8px;
                                            font-weight: 500;
                                            display: flex;
                                            align-items: center;
                                            gap: 0.5rem;
                                            transition: all 0.3s ease;
                                            box-shadow: 0 2px 8px rgba(94, 112, 84, 0.3);
                                            white-space: nowrap;
                                            margin: auto;
                                        }

                                        .search-btn:hover {
                                            background: linear-gradient(135deg, var(--primary-dark) 0%, #155a4d 100%);
                                            transform: translateY(-2px);
                                            box-shadow: 0 4px 12px rgba(94, 112, 84, 0.4);
                                        }

                                        .clear-btn {
                                            font-size: 13.3333px;
                                            font-family: Arial, Helvetica, sans-serif;
                                            background: linear-gradient(135deg, #f8f9fa 0%, var(--light-gray) 100%);
                                            color: var(--text-color);
                                            border: 2px solid var(--border-color);
                                            padding: 0.875rem 1.25rem;
                                            border-radius: 8px;
                                            font-weight: 500;
                                            display: flex;
                                            align-items: center;
                                            gap: 0.5rem;
                                            transition: all 0.3s ease;
                                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                                            white-space: nowrap;
                                        }

                                        .clear-btn:hover {
                                            background: linear-gradient(135deg, var(--border-color) 0%, #e9ecef 100%);
                                            border-color: var(--primary-color);
                                            transform: translateY(-2px);
                                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                                        }

                                        .clear-btn svg {
                                            transition: transform 0.3s ease;
                                        }

                                        .clear-btn:hover svg {
                                            transform: rotate(180deg);
                                        }

                                        /* Product List Styles */

                                        .product-list {
                                            background-color: var(--white);
                                            border-radius: 12px;
                                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                                            overflow: hidden;
                                            border: 1px solid var(--border-color);
                                        }

                                        #product-table {
                                            width: 100%;
                                            border-collapse: collapse;
                                        }

                                        #product-table th {
                                            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                                            color: var(--white);
                                            padding: 1.25rem 1rem;
                                            text-align: left;
                                            font-weight: 600;
                                            font-size: 0.95rem;
                                            border-bottom: 2px solid var(--primary-dark);
                                        }

                                        #product-table td {
                                            padding: 1rem;
                                            border-bottom: 1px solid var(--border-color);
                                            transition: background-color 0.2s ease;
                                        }

                                        #product-table tbody tr {
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        }

                                        #product-table tbody tr:hover {
                                            background-color: var(--primary-light);
                                            transform: translateY(-1px);
                                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                                        }

                                        #product-table tbody tr:nth-child(even) {
                                            background-color: #fafafa;
                                        }

                                        #product-table tbody tr:nth-child(even):hover {
                                            background-color: var(--primary-light);
                                        }

                                        /* Add Product Container */
                                        .add-product-container {
                                            margin: auto;
                                            flex-shrink: 0;
                                            display: flex;
                                            align-items: center;
                                        }

                                        .add-product-btn {
                                            margin: auto;
                                            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                                            padding: 1rem 1.5rem;
                                            font-size: 1rem;
                                            font-weight: 600;
                                            box-shadow: 0 4px 12px rgba(94, 112, 84, 0.3);
                                            border: none;
                                            transition: all 0.3s ease;
                                        }

                                        .add-product-btn:hover {
                                            background: linear-gradient(135deg, var(--primary-dark) 0%, #155a4d 100%);
                                            transform: translateY(-3px);
                                            box-shadow: 0 6px 16px rgba(94, 112, 84, 0.4);
                                        }

                                        tbody tr {
                                            transition: all 0.3s ease;
                                        }

                                        tbody tr[style*="display: none"] {
                                            opacity: 0;
                                            transform: translateY(-10px);
                                        }

                                        #no-results-row td {
                                            background: linear-gradient(135deg, #f8f9fa 0%, var(--primary-light) 100%);
                                            border-radius: 8px;
                                        }

                                        /* Sortable header styles --------------------------------------------------------------------------------------*/
                                        .sortable-header {
                                            color: var(--white);
                                            padding: 1.25rem 1rem;
                                            text-decoration: none;
                                            display: flex;
                                            align-items: center;
                                            justify-content: space-between;
                                            transition: all 0.2s ease;
                                        }

                                        .sortable-header:hover {
                                            color: var(--primary-light);
                                        }

                                        .sortable-header.active {
                                            color: var(--white);
                                            font-weight: 700;
                                        }

                                        .sort-icon {
                                            margin-left: 0.5rem;
                                            font-size: 0.8rem;
                                            opacity: 0.8;
                                        }

                                        #product-table th {
                                            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                                            color: var(--white);
                                            padding: 0;
                                            text-align: left;
                                            font-weight: 600;
                                            font-size: 0.95rem;
                                            border-bottom: 2px solid var(--primary-dark);
                                            position: relative;
                                        }

                                        #product-table th:hover {
                                            background: linear-gradient(135deg, var(--primary-dark) 0%, #155a4d 100%);
                                        }

                                        /* ------------------------------------------------------------------------------------------------------------------ */
                                        /* Responsive adjustments */
                                        @media screen and (max-width: 1024px) {
                                            .enhanced-form .product-grid.three-columns {
                                                grid-template-columns: 1fr 1fr;
                                            }

                                            .top-controls {
                                                flex-direction: column;
                                                align-items: stretch;
                                                gap: 1rem;
                                            }

                                            .search-container {
                                                min-width: unset;
                                            }

                                            .add-product-container {
                                                align-self: flex-end;
                                            }
                                        }

                                        @media screen and (max-width: 768px) {
                                            .enhanced-modal {
                                                width: 98%;
                                                margin: 1rem auto;
                                            }

                                            .enhanced-form .form-section {
                                                grid-template-columns: 1fr;
                                            }

                                            .enhanced-form .product-grid.three-columns {
                                                grid-template-columns: 1fr;
                                            }

                                            .enhanced-form .currency-pair {
                                                flex-direction: column;
                                                align-items: stretch;
                                            }

                                            .enhanced-form .form-actions {
                                                flex-direction: column;
                                                gap: 1rem;
                                            }

                                            .enhanced-form .form-actions .btn {
                                                width: 100%;
                                                text-align: center;
                                            }

                                            .search-form {
                                                flex-direction: column;
                                                gap: 1rem;
                                            }

                                            .search-group {
                                                min-width: unset;
                                            }

                                            .clear-btn {
                                                align-self: center;
                                                padding: 1rem 2rem;
                                            }

                                            .top-controls {
                                                gap: 1.5rem;
                                            }

                                            .add-product-container {
                                                align-self: stretch;
                                            }

                                            .add-product-btn {
                                                width: 100%;
                                                justify-content: center;
                                                padding: 1.25rem;
                                            }
                                        }
                                    </style>

                                    <%- include('./layout/footer') %>